#!/bin/bash

set -euo pipefail

# Various nifi REST endpoints return status code 201, however, the swagger definitions generated by swagger-maven-plugin
# list a status code of 200. See https://github.com/kongchen/swagger-maven-plugin/issues/216 for more details.
# Generating/using code using the unmodified swagger definition causes errors because the client expects status HTTP
# 200 status codes and gets HTTP 201 codes instead. To fix this, the swagger definition is modified replacing
# HTTP 200 status codes with HTTP 201 codes where necessary.

paths=(
  "/access/kerberos"
  "/access/token"
  "/controller/controller-services"
  "/controller/registry-clients"
  "/controller/reporting-tasks"
  "/parameter-contexts"
  "/policies"
  "/process-groups/{id}/connections"
  "/process-groups/{id}/controller-services"
  "/process-groups/{id}/funnels"
  "/process-groups/{id}/input-ports"
  "/process-groups/{id}/labels"
  "/process-groups/{id}/output-ports"
  "/process-groups/{id}/process-groups"
  "/process-groups/{id}/process-groups/import"
  "/process-groups/{id}/processors"
  "/process-groups/{id}/remote-process-groups"
  "/process-groups/{id}/snippet-instance"
  "/process-groups/{id}/template-instance"
  "/process-groups/{id}/templates"
  "/process-groups/{id}/templates/import"
  "/provenance"
  "/provenance-events/replays"
  "/provenance/lineage"
  "/snippets"
  "/tenants/user-groups"
  "/tenants/users"
 )

sf=$1
for path in "${paths[@]}"
do
  jq --arg p "$path" '(.paths[$p].post.responses |= (. + {"201":."200"}|del(."200")))' "${sf}" > "${sf}".tmp
  mv  "${sf}".tmp "${sf}"
done

# add security definition to nifi to align it with nifi registry's security definition
jq '. += {"securityDefinitions" : {
              "Authorization" : {
                "description" : "NiFi Auth Token (JWT)",
                "type" : "apiKey",
                "name" : "Authorization",
                "in" : "header"
              },
              "BasicAuth" : {
                "description" : "HTTP Basic Auth",
                "type" : "basic"
              }
          }}' "${sf}" > "${sf}".tmp

mv "${sf}".tmp "${sf}"
